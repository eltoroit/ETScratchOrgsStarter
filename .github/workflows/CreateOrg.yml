name: "ELTOROIT CICD Test Scratch Org"
on: [push]
jobs:
    build:
        runs-on: ubuntu-latest
        env:
            ET_CICD: true
        steps:
            # Setup the Vitual Machine
            - uses: actions/checkout@v3
            - uses: actions/setup-node@v3
              with:
                  node-version: 18
            - name: Show Node.js version
              run: |
                  node -v
            - name: Create etLogs folder
              run: |
                  mkdir -p etLogs
            # sf org display --target-org <ORG_ALIAS> --verbose --json
            # https://github.com/eltoroit/<REPO>/settings/secrets/actions/new
            # echo ${{secrets.DEVHUB_TOKEN}} > etLogs/token.txt
            - name: Write sfdxUrl to a temp file
              run: |
                  ls -la $HOME
                  echo "TOKEN"
                  echo ${{vars.DEVHUB_TOKEN}}
                  echo ${{vars.DEVHUB_TOKEN}} > $HOME/token.txt
                  ls -la $HOME
                  cat $HOME/token.txt
            - name: Install Salesforce tools
              run: |
                  wget https://developer.salesforce.com/media/salesforce-cli/sfdx/channels/stable/sfdx-linux-x64.tar.xz -q
                  mkdir $HOME/sfdx-cli
                  tar xJf sfdx-linux-x64.tar.xz -C $HOME/sfdx-cli --strip-components 1
                  export PATH=$HOME/sfdx-cli/bin:$PATH
                  echo "$PATH" >> $GITHUB_PATH
                  echo "$PATH"
                  sfdx update > etLogs/sfdx_update.out 2>etLogs/sfdx_update.err
                  sfdx force:lightning:lwc:test:setup > etLogs/sfdx_lwcTestSetup.out 2>etLogs/sfdx_lwcTestSetup.err
                  sfdx --version
                  sf --version
            - name: Install ETCopyData tools
              run: |
                  cd $HOME
                  git clone https://github.com/eltoroit/ETCopyData.git
                  cd ETCopyData
                  npm install
                  sfdx plugins:link
            # sf org display --target-org <ORG_ALIAS> --verbose --json
            # https://github.com/eltoroit/<REPO>/settings/secrets/actions/new
            # echo ${{secrets.DEVHUB_TOKEN}} > etLogs/token.txt
            - name: Register DevHub
              run: |
                  sf org login sfdx-url --sfdx-url-file "$HOME/token.txt" --set-default-dev-hub --alias DevHub
            # Create scratch org
            - name: Create Scratch Org
              run: |
                  node ./@ELTOROIT/scripts/nodejs/orgBuilder.mjs
            # Upload logs as artifacts
            - uses: actions/upload-artifact@v2
              with:
                  name: logs
                  path: |
                      etLogs
